---
import { getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import Button from '@/components/ui/Button.astro';
import SearchDialog from '@/components/blog/SearchDialog.astro';
import { formatDateLong } from '@/lib/dates';
import Icon from '@/components/ui/Icon.astro';

// Get all blog posts sorted by date (newest first)
const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);
const featuredPosts = posts.filter((post) => post.data.featured);
const regularPosts = posts.filter((post) => !post.data.featured);

// Get all unique tags
const allTags = [...new Set(posts.flatMap((post) => post.data.tags))].sort();
---

<Layout
  title="Blog - Joshua Gilman"
  description="Thoughts on infrastructure, DevOps, automation, and lessons learned from 15+ years in the trenches."
>
  <Header slot="header" />

  <div class="py-24">
    <div class="container mx-auto px-4">
      <!-- Header -->
      <div class="mb-12 max-w-3xl">
        <h1 class="mb-4 text-4xl font-bold md:text-5xl">
          <span class="text-primary font-mono">&gt;</span> Blog
        </h1>
        <p class="text-muted-foreground text-lg">
          Lessons on reliability, DevOps culture, and cost-aware delivery from 15+ years of building
          and operating platforms.
        </p>
      </div>

      <!-- Search & Filters -->
      <div class="mb-12 space-y-4">
        <SearchDialog />

        <div id="tag-filters" class="flex flex-wrap gap-2">
          {
            allTags.map((tag) => (
              <button data-tag={tag} class="tag cursor-pointer transition-colors">
                {tag}
              </button>
            ))
          }
        </div>
      </div>

      <!-- Featured Posts -->
      {
        featuredPosts.length > 0 && (
          <div id="featured-posts" class="mb-12 grid grid-cols-1 gap-6 md:grid-cols-2">
            {featuredPosts.map((post, index) => (
              <a
                href={`/blog/${post.id}`}
                class="group animate-fade-in featured-post block"
                style={`animation-delay: ${index * 0.05}s`}
                data-tags={post.data.tags.join(',').toLowerCase()}
              >
                <article class="border-border bg-card card-hover h-full overflow-hidden rounded-lg border p-6">
                  <div class="text-muted-foreground mb-4 flex flex-wrap items-center gap-4 text-sm">
                    <span class="flex items-center gap-1.5">
                      <Icon name="calendar" class="h-4 w-4" />
                      {formatDateLong(post.data.date)}
                    </span>
                    <span class="flex items-center gap-1.5">
                      <Icon name="clock" class="h-4 w-4" />
                      {post.data.readTime}
                    </span>
                    <span class="bg-primary text-primary-foreground rounded px-2 py-0.5 font-mono text-xs font-medium">
                      Featured
                    </span>
                  </div>
                  <h2 class="text-foreground group-hover:text-primary mb-3 text-2xl font-semibold transition-colors">
                    {post.data.title}
                  </h2>
                  <p class="text-muted-foreground mb-4">{post.data.excerpt}</p>
                  <div class="flex flex-wrap gap-2">
                    {post.data.tags.map((tag) => (
                      <span class="tag">{tag}</span>
                    ))}
                  </div>
                </article>
              </a>
            ))}
          </div>
        )
      }

      <!-- Subscription CTA -->
      <div
        class="border-border bg-card/70 mb-12 flex flex-col gap-4 rounded-lg border p-6 md:flex-row md:items-center md:justify-between"
      >
        <div>
          <p class="text-primary mb-1 font-mono text-sm">Stay updated</p>
          <p class="text-muted-foreground">
            Follow along for new posts on reliability, DevOps, and scaling platforms without burning
            budget.
          </p>
        </div>
        <Button href="https://linkedin.com/in/jmgilman" variant="outline">
          Follow on LinkedIn
        </Button>
      </div>

      <!-- Posts -->
      <div id="posts-container" class="space-y-8">
        {
          regularPosts.length === 0 ? (
            <div class="py-12 text-center">
              <p class="text-muted-foreground font-mono">
                <span class="text-primary">404:</span> No posts found.
              </p>
            </div>
          ) : (
            regularPosts.map((post, index) => (
              <a
                href={`/blog/${post.id}`}
                class="group animate-fade-in post-item block"
                style={`animation-delay: ${index * 0.05}s`}
                data-title={post.data.title.toLowerCase()}
                data-excerpt={post.data.excerpt.toLowerCase()}
                data-tags={post.data.tags.join(',').toLowerCase()}
              >
                <article class="bg-card border-border card-hover rounded-lg border p-6 md:p-8">
                  {/* Meta */}
                  <div class="text-muted-foreground mb-4 flex flex-wrap items-center gap-4 text-sm">
                    <span class="flex items-center gap-1.5">
                      <Icon name="calendar" class="h-4 w-4" />
                      {formatDateLong(post.data.date)}
                    </span>
                    <span class="flex items-center gap-1.5">
                      <Icon name="clock" class="h-4 w-4" />
                      {post.data.readTime}
                    </span>
                    {post.data.featured && (
                      <span class="bg-primary text-primary-foreground rounded px-2 py-0.5 font-mono text-xs font-medium">
                        Featured
                      </span>
                    )}
                  </div>

                  {/* Title */}
                  <h2 class="text-foreground group-hover:text-primary mb-3 text-2xl font-semibold transition-colors">
                    {post.data.title}
                  </h2>

                  {/* Excerpt */}
                  <p class="text-muted-foreground mb-4">{post.data.excerpt}</p>

                  {/* Tags */}
                  <div class="flex flex-wrap gap-2">
                    {post.data.tags.map((tag) => (
                      <span class="tag">{tag}</span>
                    ))}
                  </div>
                </article>
              </a>
            ))
          )
        }
      </div>

      <!-- No Results Message (hidden by default) -->
      <div id="no-results" class="hidden py-12 text-center">
        <p class="text-muted-foreground font-mono">
          <span class="text-primary">404:</span> No posts found matching your criteria.
        </p>
      </div>
    </div>
  </div>

  <Footer slot="footer" />
</Layout>

<script>
  import { initTagFilter } from '@/lib/filters';

  let teardown: (() => void) | undefined;

  const setup = () => {
    teardown?.();
    teardown = initTagFilter({
      tagButtonSelector: '#tag-filters button',
      itemSelector: '.post-item, .featured-post',
      containersToToggle: ['#posts-container', '#featured-posts'],
      noResultsSelector: '#no-results',
    });
  };

  setup();
  document.addEventListener('astro:page-load', setup);
</script>
